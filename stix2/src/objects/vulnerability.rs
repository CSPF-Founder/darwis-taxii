//! Vulnerability SDO
//!
//! A Vulnerability is a weakness in the computational logic found in software
//! and hardware components that, when exploited, results in a negative impact.

use crate::core::common::CommonProperties;
use crate::core::error::{Error, Result};
use crate::core::external_reference::ExternalReference;
use crate::core::id::Identifier;
use crate::impl_sdo_traits;
use serde::{Deserialize, Serialize};

/// Vulnerability STIX Domain Object.
///
/// A Vulnerability is a weakness in the computational logic found in software
/// and hardware components that, when exploited, results in a negative impact
/// to confidentiality, integrity, or availability.
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct Vulnerability {
    /// The type property identifies the type of STIX Object.
    #[serde(rename = "type")]
    pub type_: String,

    /// The id property uniquely identifies this object.
    pub id: Identifier,

    /// Common properties shared by all SDOs.
    #[serde(flatten)]
    pub common: CommonProperties,

    /// A name used to identify the Vulnerability.
    pub name: String,

    /// A description that provides more details about the Vulnerability.
    #[serde(skip_serializing_if = "Option::is_none")]
    pub description: Option<String>,
}

impl Vulnerability {
    /// The STIX type identifier for Vulnerability.
    pub const TYPE: &'static str = "vulnerability";

    /// Create a new VulnerabilityBuilder.
    pub fn builder() -> VulnerabilityBuilder {
        VulnerabilityBuilder::new()
    }

    /// Create a new Vulnerability with the given name.
    pub fn new(name: impl Into<String>) -> Result<Self> {
        Self::builder().name(name).build()
    }

    /// Create a vulnerability from a CVE ID.
    pub fn from_cve(cve_id: impl Into<String>) -> Result<Self> {
        let cve_id = cve_id.into();
        Self::builder()
            .name(cve_id.clone())
            .external_reference(ExternalReference::cve(cve_id))
            .build()
    }
}

impl_sdo_traits!(Vulnerability, "vulnerability");

/// Builder for creating Vulnerability objects.
#[derive(Debug, Default)]
pub struct VulnerabilityBuilder {
    name: Option<String>,
    description: Option<String>,
    external_references: Vec<ExternalReference>,
    common: CommonProperties,
}

impl VulnerabilityBuilder {
    /// Create a new builder.
    pub fn new() -> Self {
        Self::default()
    }

    /// Set the name (required).
    pub fn name(mut self, name: impl Into<String>) -> Self {
        self.name = Some(name.into());
        self
    }

    /// Set the description.
    pub fn description(mut self, description: impl Into<String>) -> Self {
        self.description = Some(description.into());
        self
    }

    /// Add an external reference.
    pub fn external_reference(mut self, reference: ExternalReference) -> Self {
        self.external_references.push(reference);
        self
    }

    /// Add a CVE reference.
    pub fn cve(self, cve_id: impl Into<String>) -> Self {
        self.external_reference(ExternalReference::cve(cve_id))
    }

    /// Set the created_by_ref.
    pub fn created_by_ref(mut self, identity_ref: Identifier) -> Self {
        self.common.created_by_ref = Some(identity_ref);
        self
    }

    /// Add a label.
    pub fn label(mut self, label: impl Into<String>) -> Self {
        self.common.labels.push(label.into());
        self
    }

    /// Build the Vulnerability.
    pub fn build(self) -> Result<Vulnerability> {
        let name = self.name.ok_or_else(|| Error::missing_property("name"))?;

        let mut common = self.common;
        common.external_references = self.external_references;

        Ok(Vulnerability {
            type_: Vulnerability::TYPE.to_string(),
            id: Identifier::new(Vulnerability::TYPE)?,
            common,
            name,
            description: self.description,
        })
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_create_vulnerability() {
        let vuln = Vulnerability::builder()
            .name("CVE-2021-44228")
            .description("Log4Shell - Remote code execution in Apache Log4j")
            .cve("CVE-2021-44228")
            .build()
            .unwrap();

        assert_eq!(vuln.name, "CVE-2021-44228");
        assert_eq!(vuln.type_, "vulnerability");
    }

    #[test]
    fn test_from_cve() {
        let vuln = Vulnerability::from_cve("CVE-2021-44228").unwrap();
        assert_eq!(vuln.name, "CVE-2021-44228");
        assert!(!vuln.common.external_references.is_empty());
    }

    #[test]
    fn test_serialization() {
        let vuln = Vulnerability::builder()
            .name("Test Vulnerability")
            .build()
            .unwrap();

        let json = serde_json::to_string(&vuln).unwrap();
        let parsed: Vulnerability = serde_json::from_str(&json).unwrap();
        assert_eq!(vuln.name, parsed.name);
    }
}
